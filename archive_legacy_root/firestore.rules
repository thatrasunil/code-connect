rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthed() {
      return request.auth != null;
    }

    function isMember(roomId) {
      // Check if a document exists in roomMembers for this user and room
      // Structure: roomMembers/{userId_roomId}
      return exists(/databases/$(database)/documents/roomMembers/$(request.auth.uid + '_' + roomId));
    }

    // Rooms Collection
    match /rooms/{roomId} {
      // Allow reading if authenticated (public rooms) or if member (private rooms logic can be added here)
      // For now, allow read if authed (simple start)
      allow read: if isAuthed();
      
      // Allow creation if authenticated
      allow create: if isAuthed();
      
      // Allow update/delete only by owner
      allow update, delete: if isAuthed() && resource.data.ownerId == request.auth.uid;
    }

    // Room Members Collection
    // ID convention: {userId}_{roomId}
    match /roomMembers/{memberId} {
      // Allow users to manage their own membership status
      allow create, update, delete: if isAuthed() && request.resource.data.userId == request.auth.uid;
      
      // Allow reading members if you are a member of the room (or just authed for simplicity in M1)
      allow read: if isAuthed(); 
    }

    // Messages Collection
    match /messages/{messageId} {
      // Allow Create/Read if user is a member of the room
      // We check the roomId field in the message/request
      allow read: if isAuthed() && isMember(resource.data.roomId);
      allow create: if isAuthed() && isMember(request.resource.data.roomId);
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
